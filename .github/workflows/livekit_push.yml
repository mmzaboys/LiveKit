name: LiveKit Config Pipeline

on:
  push:
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate docker-compose
        run: docker compose config

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVERIP }}
          username: ${{ secrets.SERVERUSER }}
          key: ${{ secrets.SERVERSSHKEY }}
          script: |
            # Install Docker if missing
            curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
            sh /tmp/get-docker.sh

            # Install docker-compose v2
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod 755 /usr/local/bin/docker-compose

            sudo systemctl enable docker

            # Install certbot if not installed
            sudo apt-get update
            sudo apt-get install -y certbot
            sudo ufw allow 22/tcp      # SSH
            sudo ufw allow 7880/tcp    # LiveKit WS/WSS
            sudo ufw allow 5349/tcp    # TURN TLS
            sudo ufw allow 50000:60000/udp  # WebRTC UDP
            sudo ufw allow 1935/tcp    # RTMP
            sudo ufw allow 8080/tcp    # WHIP
            sudo ufw --force enable

            # Setup repo
            if [ ! -d "/opt/livekit/.git" ]; then
              sudo mkdir -p /opt/livekit
              sudo chown ${{ secrets.SERVERUSER }}:${{ secrets.SERVERUSER }} /opt/livekit
              git clone https://github.com/mmzaboys/LiveKit.git /opt/livekit
            else
              cd /opt/livekit
              git pull origin main
            fi

            cd /opt/livekit

            # Stop containers
            docker compose down || true

            # Create or renew certificates
            sudo certbot certonly --standalone -n --agree-tos -m mahmoudmuhammed255@gmail.com \
              -d livekitsecrets.gleeze.com

            # Start containers
            docker compose up -d

name: Deploy LiveKit to AWS VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to AWS EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVERIP }}
          username: ubuntu
          key: ${{ secrets.SERVERSSHKEY }}
          port: 22
          timeout: 300s
          command_timeout: 30m
          script_stop: true
          debug: true
          script: |
            set -e
            echo "=== Starting deployment ==="
            
            # Switch to root and execute commands
            sudo bash -c "
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            echo 'Connected as: \$(whoami)'
            echo 'Working directory: \$(pwd)'
            
            # Update and install dependencies
            apt update -y
            apt install -y curl git
            
            # --- Docker Installation ---
            if command -v docker &> /dev/null; then
              echo '=== Docker already installed: \$(docker --version) ==='
            else
              echo '=== Installing Docker ==='
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              usermod -aG docker ubuntu
            fi
            
            # --- Docker Compose Installation ---
            if command -v docker-compose &> /dev/null; then
              echo '=== Docker Compose already installed: \$(docker-compose --version) ==='
            else
              echo '=== Installing Docker Compose ==='
              curl -L \"https://github.com/docker/compose/releases/latest/download/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose 2>/dev/null || true
            fi
            
            # Start Docker service
            systemctl enable docker
            systemctl start docker
            
            # Wait a moment for Docker to be ready
            sleep 5
            "
            
            # Continue as ubuntu user for the application setup
            echo "=== Setting up LiveKit application ==="
            
            LIVEKIT_DIR="/home/ubuntu/livekit"
            sudo rm -rf "$LIVEKIT_DIR"
            sudo git clone https://github.com/mmzaboys/LiveKit.git "$LIVEKIT_DIR"
            sudo chown -R ubuntu:ubuntu "$LIVEKIT_DIR"
            
            cd "$LIVEKIT_DIR"
            
          
            
            echo "APP_DOMAIN=${{ secrets.DOMAIN }}" > .env
            echo "SSL_EMAIL=${{ secrets.EMAIL }}" >> .env
            echo "LIVEKIT_DOMAIN=${{ secrets.DOMAIN }}" >> .env
            echo "LIVEKIT_API_KEY=${{ secrets.KEY }}" >> .env
            echo "LIVEKIT_API_SECRET=${{ secrets.SECRET }}" >> .env
            
            sudo chmod +x init-letsencrypt.sh configfiles.sh
            sudo chown ubuntu:ubuntu .env
            
            # Run the application setup
            sudo -u ubuntu bash -c "
            set -e
            cd '$LIVEKIT_DIR'
            
            echo '=== Starting LiveKit services ==='
            docker-compose down || true
            ./configfiles.sh
            ./init-letsencrypt.sh
            docker-compose up -d
            
            sleep 10
            docker ps
            docker-compose logs --tail=10 || echo 'Logs check completed'
            "
            
            echo "ðŸŽ‰ === Deployment completed successfully ==="
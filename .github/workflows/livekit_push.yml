name: Deploy LiveKit to gcp VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to gcp vm
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVERIP }}
          username: ubuntu
          key: ${{ secrets.SERVERSSHKEY }}
          port: 22
          timeout: 300s
          command_timeout: 30m
          script_stop: true
          debug: true
          script: |
            set -e
            echo "=== Starting deployment ==="
            
            # Switch to root and execute commands
            sudo bash -c "
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            echo 'Connected as: \$(whoami)'
            echo 'Working directory: \$(pwd)'
            
            # Update and install dependencies
            apt update -y
            apt install -y curl git
            
            # --- Docker Installation ---
            if command -v docker &> /dev/null; then
              echo '=== Docker already installed: \$(docker --version) ==='
            else
              echo '=== Installing Docker ==='
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              usermod -aG docker ubuntu
            fi
            
            # --- Docker Compose Installation ---
            if command -v docker-compose &> /dev/null; then
              echo '=== Docker Compose already installed: \$(docker-compose --version) ==='
            else
              echo '=== Installing Docker Compose ==='
              curl -L \"https://github.com/docker/compose/releases/latest/download/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose 2>/dev/null || true
            fi
            
            # Start Docker service
            systemctl enable docker
            systemctl start docker
            
            # Wait a moment for Docker to be ready
            sleep 5
            "
            
            # Continue as ubuntu user for the application setup
            echo "=== Setting up LiveKit application ==="
            
            LIVEKIT_DIR="/home/ubuntu/livekit"
            sudo rm -rf "$LIVEKIT_DIR"
            sudo git clone https://github.com/mmzaboys/LiveKit.git "$LIVEKIT_DIR"
            sudo chown -R ubuntu:ubuntu "$LIVEKIT_DIR"
            
            cd "$LIVEKIT_DIR"
            
          
            
            echo "APP_DOMAIN=${{ secrets.DOMAIN }}" > .env
            echo "SSL_EMAIL=${{ secrets.EMAIL }}" >> .env
            echo "LIVEKIT_DOMAIN=${{ secrets.DOMAIN }}" >> .env
            echo "LIVEKIT_API_KEY=${{ secrets.KEY }}" >> .env
            echo "LIVEKIT_API_SECRET=${{ secrets.SECRET }}" >> .env
            
            sudo chmod +x init-letsencrypt.sh configfiles.sh
            sudo chown ubuntu:ubuntu .env
            
            # Run the application setup
            sudo -u ubuntu bash -c "
            set -e
            cd '$LIVEKIT_DIR'
            
            echo '=== Starting LiveKit services ==='
            docker-compose down || true
            ./configfiles.sh
            ./init-letsencrypt.sh
            docker-compose up -d
            
            sleep 10
            docker ps
            docker-compose logs --tail=10 || echo 'Logs check completed'
            "
            
            echo "ğŸ‰ === Deployment completed successfully ==="
            echo "ğŸ“Š Reinstalling Node Exporter from scratch..."

            # Stop and disable old service if it exists
            if systemctl list-unit-files | grep -q "node_exporter.service"; then
                echo "ğŸ›‘ Removing old Node Exporter service..."
                sudo systemctl stop node_exporter 2>/dev/null || true
                sudo systemctl disable node_exporter 2>/dev/null || true
                sudo rm -f /etc/systemd/system/node_exporter.service
            fi

            # Remove old binary if exists
            if [ -f /usr/local/bin/node_exporter ]; then
                echo "ğŸ—‘ Removing old Node Exporter binary..."
                sudo rm -f /usr/local/bin/node_exporter
            fi

            # Config
            NODE_EXPORTER_VERSION="1.7.0"
            ARCH="amd64"
            DOWNLOAD_URL="https://github.com/prometheus/node_exporter/releases/download/v${NODE_EXPORTER_VERSION}/node_exporter-${NODE_EXPORTER_VERSION}.linux-${ARCH}.tar.gz"

            # Get public IP safely
            get_public_ip() {
                local ip
                ip=$(curl -s -f --connect-timeout 5 ifconfig.me 2>/dev/null || echo "localhost")
                echo "$ip"
            }
            PUBLIC_IP=$(get_public_ip)

            # Download fresh package
            cd /home/ubuntu || { echo "âŒ Home directory missing"; exit 1; }
            TEMP_DIR=$(mktemp -d)
            cd "$TEMP_DIR" || { echo "âŒ Failed to enter temp dir"; exit 1; }

            echo "ğŸ“¥ Downloading Node Exporter v${NODE_EXPORTER_VERSION}..."
            if ! wget -q --timeout=30 "$DOWNLOAD_URL"; then
                echo "âŒ Failed to download Node Exporter"
                cd /home/ubuntu && rm -rf "$TEMP_DIR"
                exit 1
            fi

            echo "ğŸ“¦ Extracting..."
            if ! tar xzf "node_exporter-${NODE_EXPORTER_VERSION}.linux-${ARCH}.tar.gz"; then
                echo "âŒ Failed to extract archive"
                cd /home/ubuntu && rm -rf "$TEMP_DIR"
                exit 1
            fi

            echo "ğŸ”¨ Installing binary..."
            sudo cp "node_exporter-${NODE_EXPORTER_VERSION}.linux-${ARCH}/node_exporter" /usr/local/bin/

            # Create user if missing
            if ! id "node_exporter" &>/dev/null; then
                echo "ğŸ‘¤ Creating node_exporter user..."
                sudo useradd --no-create-home --shell /bin/false node_exporter || true
            else
                echo "âœ… User node_exporter already exists"
            fi
            sudo chown node_exporter:node_exporter /usr/local/bin/node_exporter || true

            # Create clean service file using multiple methods
            echo "ğŸ¯ Creating systemd service..."

            # Method 1: Create service file using printf (most reliable)
            sudo tee /etc/systemd/system/node_exporter.service > /dev/null <<'EOL'
            [Unit]
            Description=Node Exporter
            Documentation=https://github.com/prometheus/node_exporter
            Wants=network-online.target
            After=network-online.target

            [Service]
            User=node_exporter
            Group=node_exporter
            Type=simple
            Restart=on-failure
            RestartSec=5
            ExecStart=/usr/local/bin/node_exporter --web.listen-address=:9100 --path.rootfs=/

            [Install]
            WantedBy=multi-user.target
            EOL

            # Verify the service file was created correctly
            if ! sudo grep -q "Description=Node Exporter" /etc/systemd/system/node_exporter.service 2>/dev/null; then
                echo "âš ï¸ Service file may be corrupted, trying alternative method..."
                
                # Method 2: Use a temporary file
                cat > /tmp/node_exporter.service <<'EOL'
            [Unit]
            Description=Node Exporter
            Documentation=https://github.com/prometheus/node_exporter
            Wants=network-online.target
            After=network-online.target

            [Service]
            User=node_exporter
            Group=node_exporter
            Type=simple
            Restart=on-failure
            RestartSec=5
            ExecStart=/usr/local/bin/node_exporter --web.listen-address=:9100 --path.rootfs=/

            [Install]
            WantedBy=multi-user.target
            EOL
                
                sudo mv /tmp/node_exporter.service /etc/systemd/system/node_exporter.service
                sudo chmod 644 /etc/systemd/system/node_exporter.service
            fi

            # Verify binary permissions and integrity
            echo "ğŸ” Verifying installation..."
            if [ ! -f /usr/local/bin/node_exporter ]; then
                echo "âŒ Binary not found at /usr/local/bin/node_exporter"
                exit 1
            fi

            if ! sudo -u node_exporter /usr/local/bin/node_exporter --version >/dev/null 2>&1; then
                echo "âŒ Binary is not executable or corrupted"
                echo "ğŸ“‹ Binary info:"
                ls -la /usr/local/bin/node_exporter
                file /usr/local/bin/node_exporter
                exit 1
            fi

            echo "âœ… Binary verified successfully"

            # Enable + start
            echo "ğŸš€ Starting Node Exporter..."
            sudo systemctl daemon-reload

            if ! sudo systemctl enable node_exporter; then
                echo "âš ï¸ Could not enable service, but continuing..."
            fi

            if ! sudo systemctl start node_exporter; then
                echo "âŒ Failed to start service"
                echo "ğŸ“‹ Checking service status..."
                sudo systemctl status node_exporter --no-pager || true
                echo "ğŸ“‹ Journal logs:"
                sudo journalctl -u node_exporter --no-pager -n 20 || true
                exit 1
            fi

            # Wait and verify
            sleep 8

            if systemctl is-active --quiet node_exporter; then
                echo "âœ… Node Exporter running successfully!"
                echo "ğŸ“ˆ Metrics endpoints:"
                echo "   Public: http://${PUBLIC_IP}:9100/metrics"
                echo "   Local:  http://localhost:9100/metrics"
                echo "   Status: sudo systemctl status node_exporter"
                
                # Test metrics endpoint
                echo "ğŸ” Testing metrics endpoint..."
                if curl -s --connect-timeout 5 http://localhost:9100/metrics | head -5 >/dev/null 2>&1; then
                    echo "âœ… Metrics endpoint responding correctly"
                else
                    echo "âš ï¸ Metrics endpoint may not be accessible"
                fi
            else
                echo "âŒ Node Exporter failed to start!"
                echo "ğŸ“‹ Service status:"
                sudo systemctl status node_exporter --no-pager || true
                echo "ğŸ“‹ Recent logs:"
                sudo journalctl -u node_exporter --no-pager -n 30 || true
                exit 1
            fi

            # Cleanup
            cd /home/ubuntu && rm -rf "$TEMP_DIR"
            echo "ğŸ‰ Node Exporter reinstallation completed successfully!"